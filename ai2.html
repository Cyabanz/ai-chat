<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fusion AI Chat â€“ Multi-Conversation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase Core -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #181c24;
      color: #e8eaf0;
      height: 100vh;
      overflow: hidden;
    }

    /* Auth Section */
    #auth-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #181c24 0%, #232946 100%);
    }

    #auth-section h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #90caf9;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #auth-section p {
      color: #b0b7c3;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    #google-btn {
      background: #90caf9;
      color: #181c24;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    #google-btn:hover {
      background: #1976d2;
      color: #fff;
      transform: translateY(-1px);
    }

    #auth-error {
      color: #e53935;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }

    /* Main Layout */
    #main-flex {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    #sidebar {
      width: 300px;
      background: #202538;
      border-right: 1px solid #2d3748;
      display: flex;
      flex-direction: column;
    }

    #sidebar-header {
      padding: 1.5rem;
      background: #232946;
      border-bottom: 1px solid #2d3748;
      font-size: 1.2rem;
      font-weight: 600;
      color: #90caf9;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #sidebar-btns {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    #sidebar-btns button {
      background: #232946;
      color: #e8eaf0;
      border: 1px solid #2d3748;
      border-radius: 6px;
      padding: 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    #sidebar-btns button:hover {
      background: #2d3748;
      border-color: #90caf9;
    }

    #new-convo-btn {
      background: #90caf9 !important;
      color: #181c24 !important;
      border-color: #90caf9 !important;
    }

    #new-convo-btn:hover {
      background: #1976d2 !important;
      color: #fff !important;
    }

    #convo-list {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0 1rem;
    }

    .convo-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .convo-item:hover {
      background: #232946;
      border-color: #2d3748;
    }

    .convo-item.active {
      background: #232946;
      border-color: #90caf9;
    }

    .convo-title {
      flex: 1;
      font-size: 0.9rem;
      color: #e8eaf0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .convo-actions button {
      background: none;
      border: none;
      color: #b0b7c3;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      font-size: 1rem;
      transition: color 0.2s ease;
    }

    .convo-actions button:hover {
      color: #e53935;
      background: #2d3748;
    }

    /* Main Chat Container */
    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #181c24;
    }

    .header {
      background: #232946;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #2d3748;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header i {
      font-size: 1.5rem;
      color: #90caf9;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #e8eaf0;
      margin: 0;
    }

    /* Usage Bar */
    .usage-bar {
      background: #202538;
      padding: 1rem 2rem;
      border-bottom: 1px solid #2d3748;
      display: flex;
      gap: 2rem;
    }

    .usage-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .usage-label {
      font-size: 0.9rem;
      color: #b0b7c3;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .usage-count {
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .usage-count.normal {
      background: #232946;
      color: #90caf9;
    }

    .usage-count.warning {
      background: #ff9800;
      color: #181c24;
    }

    .usage-count.limit {
      background: #e53935;
      color: #fff;
    }

    /* Controls */
    .controls {
      background: #202538;
      padding: 1rem 2rem;
      border-bottom: 1px solid #2d3748;
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .controls > div {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls label {
      font-size: 0.9rem;
      color: #b0b7c3;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
    }

    .controls select {
      background: #232946;
      color: #e8eaf0;
      border: 1px solid #2d3748;
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.9rem;
      min-width: 150px;
    }

    .controls select:focus {
      outline: none;
      border-color: #90caf9;
    }

    /* Chat Box */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Messages */
    .message {
      display: flex;
      flex-direction: column;
      max-width: 85%;
    }

    .message.user {
      align-self: flex-end;
    }

    .message.ai {
      align-self: flex-start;
    }

    .message-sender-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .profile-circle-ai,
    .profile-circle-user {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .profile-circle-ai {
      background: #90caf9;
      color: #181c24;
    }

    .profile-circle-user {
      background: #232946;
      color: #90caf9;
      border: 1px solid #2d3748;
    }

    .message-sender {
      font-size: 0.85rem;
      font-weight: 600;
      color: #b0b7c3;
    }

    .message-content {
      background: #232946;
      border: 1px solid #2d3748;
      border-radius: 12px;
      padding: 1rem;
      color: #e8eaf0;
      line-height: 1.5;
    }

    .message.user .message-content {
      background: #90caf9;
      color: #181c24;
      border-color: #90caf9;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 1rem;
    }

    .typing-dots {
      display: flex;
      gap: 0.25rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #90caf9;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Input Section */
    .input-section {
      background: #202538;
      border-top: 1px solid #2d3748;
      padding: 1.5rem 2rem;
    }

    .input-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    #user-input {
      flex: 1;
      background: #232946;
      color: #e8eaf0;
      border: 1px solid #2d3748;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
    }

    #user-input:focus {
      outline: none;
      border-color: #90caf9;
    }

    #send-btn {
      background: #90caf9;
      color: #181c24;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    #send-btn:hover:not(:disabled) {
      background: #1976d2;
      color: #fff;
    }

    #send-btn:disabled {
      background: #2d3748;
      color: #b0b7c3;
      cursor: not-allowed;
    }

    .button-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn-secondary,
    .btn-info {
      background: #232946;
      color: #e8eaf0;
      border: 1px solid #2d3748;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover,
    .btn-info:hover {
      background: #2d3748;
      border-color: #90caf9;
    }

    .btn-info:disabled {
      background: #1a1d25;
      color: #666;
      border-color: #2d3748;
      cursor: not-allowed;
    }

    /* Notices */
    .limit-notice,
    .error-notice {
      background: #e53935;
      color: #fff;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    .limit-notice {
      background: #ff9800;
      color: #181c24;
    }

    /* Search History */
    .search-history {
      margin-top: 1rem;
    }

    .search-history h4 {
      color: #90caf9;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .search-item {
      background: #202538;
      border: 1px solid #2d3748;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .search-item strong {
      color: #90caf9;
    }

    .search-item small {
      color: #b0b7c3;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #202538;
    }

    ::-webkit-scrollbar-thumb {
      background: #2d3748;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #90caf9;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #main-flex {
        flex-direction: column;
      }

      #sidebar {
        width: 100%;
        height: auto;
        order: 2;
        border-right: none;
        border-top: 1px solid #2d3748;
      }

      #container {
        order: 1;
        height: 70vh;
      }

      .controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }

      .controls > div {
        justify-content: space-between;
      }

      .controls select {
        min-width: auto;
        flex: 1;
      }

      .usage-bar {
        flex-direction: column;
        gap: 0.5rem;
      }

      .button-row {
        justify-content: center;
      }

      .header {
        padding: 1rem;
      }

      .input-section {
        padding: 1rem;
      }

      #chat-box {
        padding: 1rem;
      }

      .controls,
      .usage-bar {
        padding: 1rem;
      }
    }

    @media (max-width: 480px) {
      .message {
        max-width: 95%;
      }

      .input-row {
        flex-direction: column;
      }

      #send-btn {
        align-self: flex-end;
        min-width: 100px;
      }

      .button-row {
        flex-direction: column;
      }

      .btn-secondary,
      .btn-info {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div id="auth-section">
  <h2><i class='bx bx-bot'></i> Sign in to Fusion AI Chat</h2>
  <p>Please sign in with your Google account to start chatting</p>
  <button id="google-btn"><i class='bx bxl-google'></i> Sign in with Google</button>
  <div id="auth-error"></div>
</div>

<div id="main-flex" style="display:none;">
  <div id="sidebar">
    <div id="sidebar-header"><i class='bx bx-chat'></i> Conversations</div>
    <div id="sidebar-btns">
      <button id="new-convo-btn"><i class='bx bx-plus'></i> New conversation</button>
      <button id="logout-btn"><i class='bx bx-log-out'></i> Logout</button>
    </div>
    <ul id="convo-list"></ul>
  </div>
  
  <div id="container">
    <div class="header">
      <i class='bx bx-bot'></i>
      <h1 id="convo-title">Fusion AI Chat</h1>
    </div>
    
    <div class="usage-bar">
      <div class="usage-item">
        <span class="usage-label"><i class='bx bx-message-square-dots'></i> Messages (per hour)</span>
        <span id="message-count" class="usage-count normal">0/10</span>
      </div>
      <div class="usage-item">
        <span class="usage-label"><i class='bx bx-search-alt-2'></i> Web Searches (per day)</span>
        <span id="search-count" class="usage-count normal">0/5</span>
      </div>
    </div>
    
    <div class="controls">
      <div>
        <label for="personality"><i class='bx bx-user-circle'></i> AI Personality:</label>
        <select id="personality">
          <option value="Friendly">Friendly (GPT-3.5)</option>
          <option value="Professional">Professional (GPT-4o Mini)</option>
          <option value="Humorous">Humorous (Claude-3 Haiku)</option>
          <option value="Creative">Creative (GPT-4o)</option>
          <option value="Analytical">Analytical (GPT-4o)</option>
        </select>
      </div>
      <div>
        <label for="model-select"><i class='bx bx-chip'></i> Model Override:</label>
        <select id="model-select">
          <option value="">Auto (based on personality)</option>
          <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
          <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
          <option value="openai/gpt-4o">GPT-4o</option>
          <option value="anthropic/claude-3-haiku">Claude-3 Haiku</option>
          <option value="anthropic/claude-3-sonnet">Claude-3 Sonnet</option>
          <option value="google/gemini-pro">Gemini Pro</option>
        </select>
      </div>
    </div>
    
    <div id="chat-box"></div>
    
    <div class="input-section">
      <div class="input-row">
        <input type="text" id="user-input" placeholder="Type your message here..." maxlength="500">
        <button id="send-btn">Send</button>
      </div>
      <div class="button-row">
        <button id="clear-history" class="btn-secondary"><i class='bx bx-trash'></i> Clear Conversation</button>
        <button id="export-history" class="btn-secondary"><i class='bx bx-download'></i> Export Conversation</button>
        <button id="web-search" class="btn-info"><i class='bx bx-search'></i> Web Search</button>
        <button id="view-search-history" class="btn-info"><i class='bx bx-history'></i> Search History</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Firebase Setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
    authDomain: "fusioncya-cc20a.firebaseapp.com",
    databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
    projectId: "fusioncya-cc20a",
    storageBucket: "fusioncya-cc20a.appspot.com",
    messagingSenderId: "765164293111",
    appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
    measurementId: "G-4DT52P7MPB"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // --- Auth UI Logic ---
  const authSection = document.getElementById('auth-section');
  const mainFlex = document.getElementById('main-flex');
  const logoutBtn = document.getElementById('logout-btn');
  const googleBtn = document.getElementById('google-btn');
  const authError = document.getElementById('auth-error');

  function showAuthError(msg) { authError.textContent = msg; }
  function clearAuthError() { authError.textContent = ""; }

  googleBtn.onclick = async () => {
    clearAuthError();
    googleBtn.disabled = true;
    googleBtn.innerHTML = "<i class='bx bxs-hourglass bx-spin'></i> Signing in...";
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    try {
      await auth.signInWithPopup(provider);
    } catch (e) {
      showAuthError(`Authentication failed: ${e.message}`);
    } finally {
      googleBtn.disabled = false;
      googleBtn.innerHTML = "<i class='bx bxl-google'></i> Sign in with Google";
    }
  };

  logoutBtn.onclick = () => {
    if (confirm('Are you sure you want to sign out?')) {
      auth.signOut();
    }
  };

  // --- Multi-Convo Chat Logic ---
  let fusionChat = null;
  let userId = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      mainFlex.style.display = '';
      authSection.style.display = 'none';
      if (!fusionChat) {
        fusionChat = new FusionAIChat(userId);
      }
    } else {
      userId = null;
      mainFlex.style.display = 'none';
      authSection.style.display = '';
      fusionChat = null;
    }
  });

  function uuid() {
    // Simple uuid for Firebase keys
    return 'xxyxxyxxxyx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    }) + Date.now();
  }

  class FusionAIChat {
    constructor(uid) {
      this.uid = uid;
      // Sidebar elements
      this.convoListEl = document.getElementById('convo-list');
      this.newConvoBtn = document.getElementById('new-convo-btn');
      this.logoutBtn = document.getElementById('logout-btn');
      // Main chat elements
      this.chatBox = document.getElementById('chat-box');
      this.userInput = document.getElementById('user-input');
      this.sendBtn = document.getElementById('send-btn');
      this.clearHistoryBtn = document.getElementById('clear-history');
      this.exportHistoryBtn = document.getElementById('export-history');
      this.webSearchBtn = document.getElementById('web-search');
      this.viewSearchHistoryBtn = document.getElementById('view-search-history');
      this.personalitySelect = document.getElementById('personality');
      this.modelSelect = document.getElementById('model-select');
      this.messageCountEl = document.getElementById('message-count');
      this.searchCountEl = document.getElementById('search-count');
      this.convoTitle = document.getElementById('convo-title');
      // Data
      this.conversations = {}; // { id: {meta, messages: []}}
      this.activeConvoId = null;
      this.usageData = this.initializeUsageData();
      this.searchHistory = [];
      this.isTyping = false;
      // Firebase refs
      this.firebaseConvoListRef = db.ref(`users/${this.uid}/conversations`);
      this.firebaseUsageRef = db.ref(`users/${this.uid}/usageData`);
      this.firebaseSearchRef = db.ref(`users/${this.uid}/searchHistory`);
      // Listeners/UI
      this.initializeEventListeners();
      this.listenToFirebase();
      this.updateUsageDisplay();
      this.startUsageResetTimer();
    }

    initializeEventListeners() {
      this.newConvoBtn.addEventListener('click', () => this.createNewConversation());
      this.sendBtn.addEventListener('click', () => this.sendMessage());
      this.clearHistoryBtn.addEventListener('click', () => this.clearConversation());
      this.exportHistoryBtn.addEventListener('click', () => this.exportConversation());
      this.webSearchBtn.addEventListener('click', () => this.performWebSearch());
      this.viewSearchHistoryBtn.addEventListener('click', () => this.showSearchHistory());
      this.userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.userInput.addEventListener('input', () => this.updateSendButtonState());
      setTimeout(() => this.userInput.focus(), 500);
    }

    listenToFirebase() {
      this.firebaseConvoListRef.on('value', (snapshot) => {
        this.conversations = snapshot.val() || {};
        this.renderSidebar();
        // If no active convo, pick the first available
        if (!this.activeConvoId && Object.keys(this.conversations).length > 0) {
          this.setActiveConversation(Object.keys(this.conversations)[0]);
        }
        // If no conversations at all, create one
        if (Object.keys(this.conversations).length === 0) {
          this.createNewConversation();
        }
        // After updating conversations, re-render chat window for active convo
        if (this.activeConvoId && this.conversations[this.activeConvoId]) {
          this.renderChatHistory();
        }
      });
      this.firebaseUsageRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
          this.usageData = snapshot.val();
          this.updateUsageDisplay();
        }
      });
      this.firebaseSearchRef.on('value', (snapshot) => {
        this.searchHistory = snapshot.val() || [];
      });
    }

    initializeUsageData() {
      const now = new Date();
      return {
        messages: { count: 0, resetTime: new Date(now.getTime() + 60 * 60 * 1000).toISOString() },
        searches: { count: 0, resetTime: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString() }
      };
    }

    startUsageResetTimer() {
      setInterval(() => {
        const now = new Date();
        let changed = false;
        let usage = {...this.usageData};
        if (now >= new Date(usage.messages.resetTime)) {
          usage.messages.count = 0;
          usage.messages.resetTime = new Date(now.getTime() + 60 * 60 * 1000).toISOString();
          changed = true;
        }
        if (now >= new Date(usage.searches.resetTime)) {
          usage.searches.count = 0;
          usage.searches.resetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
          changed = true;
        }
        if (changed) {
          this.usageData = usage;
          this.firebaseUsageRef.set(usage);
        }
      }, 60000);
    }

    updateUsageDisplay() {
      this.messageCountEl.textContent = `${this.usageData.messages.count}/10`;
      this.messageCountEl.className = 'usage-count ' + this.getUsageClass(this.usageData.messages.count, 10);
      this.searchCountEl.textContent = `${this.usageData.searches.count}/5`;
      this.searchCountEl.className = 'usage-count ' + this.getUsageClass(this.usageData.searches.count, 5);
      this.webSearchBtn.disabled = this.usageData.searches.count >= 5;
      this.updateSendButtonState();
    }